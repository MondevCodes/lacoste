name: Discord Bot Lala Update Notification

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  notify-discord:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Get Discord ID mapping
        id: discord-mapping
        run: |
          GITHUB_USER="${{ github.event.pull_request.user.login }}"
          case "$GITHUB_USER" in
            "pedromondek") DISCORD_ID="223554902209724417" ;;
            "cauemondek") DISCORD_ID="320583308646023189" ;;
            *) DISCORD_ID="" ;;
          esac
          echo "discord_id=$DISCORD_ID" >> $GITHUB_OUTPUT
          echo "github_user=$GITHUB_USER" >> $GITHUB_OUTPUT
      - name: Get PR comments
        id: get-comments
        env:
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          COMMENTS_RESPONSE=$(curl -s -H "Authorization: token ${{ github.token }}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments")
          REVIEW_COMMENTS_RESPONSE=$(curl -s -H "Authorization: token ${{ github.token }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments")
          ALL_COMMENTS=""
          if [ "$COMMENTS_RESPONSE" != "[]" ]; then
            GENERAL_COMMENTS=$(echo "$COMMENTS_RESPONSE" | jq -r --arg author "$PR_AUTHOR" '.[] | select(.user.login == $author) | .body' | head -c 500)
            ALL_COMMENTS="$ALL_COMMENTS $GENERAL_COMMENTS"
          fi
          if [ "$REVIEW_COMMENTS_RESPONSE" != "[]" ]; then
            REVIEW_COMMENTS=$(echo "$REVIEW_COMMENTS_RESPONSE" | jq -r --arg author "$PR_AUTHOR" '.[] | select(.user.login == $author) | .body' | head -c 500)
            ALL_COMMENTS="$ALL_COMMENTS $REVIEW_COMMENTS"
          fi
          echo "result<<EOF" >> $GITHUB_OUTPUT
          echo "$ALL_COMMENTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      - name: Send Discord notification
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_COMMENTS: ${{ steps.get-comments.outputs.result }}
          GITHUB_USER: ${{ steps.discord-mapping.outputs.github_user }}
          DISCORD_ID: ${{ steps.discord-mapping.outputs.discord_id }}
        run: |
          DISCORD_MENTION=""
          if [ -n "$DISCORD_ID" ]; then
            DISCORD_MENTION=" / <@${DISCORD_ID}>"
          fi

          # Sanitizar e limitar o corpo do PR
          CLEAN_BODY=$(echo "$PR_BODY" | tr '\n\r' ' ' | head -c 500)
          CLEAN_COMMENTS=$(echo "$PR_COMMENTS" | tr '\n\r' ' ' | head -c 300)

          MESSAGE=$(printf "ðŸ“œðŸ¤– **Bot Lala Atualizado @everyone!**\n\n**Autor da AtualizaÃ§Ã£o:** %s%s\n\n**Notas da AtualizaÃ§Ã£o:**\n%s %s" "$GITHUB_USER" "$DISCORD_MENTION" "$CLEAN_BODY" "$CLEAN_COMMENTS")

          # Usar jq para criar JSON vÃ¡lido
          JSON_PAYLOAD=$(jq -n --arg msg "$MESSAGE" '{content: $msg}')

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$JSON_PAYLOAD" \
               "${{ secrets.DISCORD_WEBHOOK }}"
